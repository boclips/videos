---
title: "Search analysis: past 30 days"
output: pdf_document
---

# How are search queries counted
In this analysis we count search queries as distinct phrases typed by a user. That means that:

- When a user types some text and hits 'search', this is counted as one search query.
- When a user explores further pages of search results, it is NOT counted as another query.
- When a user uses filters to narrow down results, it is NOT counted as another query.
- When a user goes back to boclips one week after they made a search and types the same phrase they had used before, it is NOT counted as another query.
- When two different users type the same text, it is counted as 2 queries.

The following numbers are based on the above definition.

```{r setup, include=FALSE}
library(knitr)
library(stringr)
library(urltools)

knitr::opts_chunk$set(echo = TRUE)

objectIdValueOf = function(s) {
  return(regmatches(s,regexpr("[a-z0-9]{24}",s)))
}

parseUrl = function(url) {
  pattern = "(?:.*://)?([^/]+)/search/([^?]*)[?]?.*"
  columns = str_match(url, pattern)
  colnames(columns) = c("url", "theme", "query")
  return(columns)
}

allSearches = read.csv("all-searches.csv", col.names = c("url", "user", "timestamp"), colClasses = c("character", "character", "Date"))
allSearches$user = factor(objectIdValueOf(allSearches$user))

allSearches = merge(x = allSearches, y = parseUrl(allSearches$url), by = "url")
allSearches$query = url_decode(allSearches$query)

userDetails = read.csv("all-users.csv", col.names = c("id", "email", "name", "surname"), colClasses = "character")
userDetails$id = factor(objectIdValueOf(userDetails$id))

allSearches = merge(x = allSearches, y = userDetails, by.x = "user", by.y = "id")

allSearches=subset(allSearches, !grepl("boclips.com", email))
allSearches = subset(allSearches, timestamp > as.Date("2018-04-15"))

oupSearches = allSearches[endsWith(allSearches$email, "oup.com"),]
allSearches = subset(allSearches, select = c("user", "query", "theme"))
allSearches = unique(allSearches)
```



# Volume of search queries
```{r themes, echo=FALSE}
oneMonthSearches = data.frame(allSearches)
oneMonthSearches$theme = factor(oneMonthSearches$theme)
oneMonthSearches$user = factor(oneMonthSearches$user)

themeFrequencies=data.frame(table(data.frame(oneMonthSearches$theme)))
colnames(themeFrequencies)=c("theme", "count")

kable(themeFrequencies[,1:2], caption = "Queries by theme", col.names = c("Theme", "Count"))
par(cex=0.7)
plot(themeFrequencies, type="s", xlab="Theme", ylab="Count")

```

# Most active users per theme
Here are the users who made the most number of search queries recently.
```{r users, echo=FALSE}
userFrequencies=data.frame(table(data.frame(oneMonthSearches$user)))
colnames(userFrequencies)=c("user", "count")

userTheme = unique(subset(oneMonthSearches, select=c("user", "theme")))
userFrequencies = merge(x = userFrequencies, y = userTheme, by = "user")
userFrequencies = merge(x = userFrequencies, y = userDetails, by.x = "user", by.y = "id")

userFrequencies = userFrequencies[order(-userFrequencies$count),]

activeUsersByTheme = function(themeName) {
  filteredUsers = subset(userFrequencies, theme == themeName & count > 5)
  filteredUsers = head(filteredUsers, 50)
  filteredUsers = subset(filteredUsers, select=c("name", "surname", "email", "count"))
  kable(filteredUsers, caption = paste("Most active users on", themeName), row.names = FALSE, col.names = c("First Name", "Last Name", "Email", "# Queries"))
}

activeUsersByTheme("boclips.com")
activeUsersByTheme("pearson.boclips.com")
activeUsersByTheme("watchboclips.com")
# activeUsersByTheme("lbs.boclips.com")
```


# Search phrases
Here are the most commonly used search phrases.
```{r phraseFreqs, echo=FALSE}
topPhrasesByTheme = function(themeName) {
  allPhrases = subset(allSearches, theme == themeName)
  allPhrases = subset(allPhrases, select = c("query"))
  colnames(allPhrases)=c("text")
  
  allPhrases$text = tolower(allPhrases$text)
  allPhrases$text = gsub("[^[:alnum:][:space:]]","",allPhrases$text)
  allPhrases = subset(allPhrases, text != "")
  
  
  phraseHist = data.frame(table(allPhrases))
  phraseHist = phraseHist[order(phraseHist$Freq, decreasing = TRUE),]
  phraseHist = head(phraseHist, 100)
  phraseHist = subset(phraseHist, Freq > 1)
  colnames(phraseHist) = c("Phrase", "Count")
  kable(phraseHist, row.names = FALSE, caption = paste("Most frequent phrases on", themeName))
}

topPhrasesByTheme("boclips.com")
topPhrasesByTheme("pearson.boclips.com")
topPhrasesByTheme("watchboclips.com")

```

## Search words
```{r wordFreqs, echo=FALSE}
topWordsByTheme = function(themeName) {
  themeSearches = subset(allSearches, theme == themeName)
  splitWords = strsplit(as.character(themeSearches$query), " ")
  allWords = data.frame(unlist(splitWords))
  colnames(allWords)=c("word")
  
  allWords$word = tolower(allWords$word)
  allWords$word = gsub("[^[:alnum:][:space:]]","",allWords$word)
  stopwords = c("", "and", "or", "in", "of", "the", "to", "a")
  allWords = subset(allWords, !(word %in% stopwords))
  
  wordsHist = data.frame(table(allWords))
  wordsHist = wordsHist[order(wordsHist$Freq, decreasing = TRUE),]
  wordsHist = head(wordsHist, 100)
  wordsHist = subset(wordsHist, Freq > 1)
  colnames(wordsHist) = c("Word", "Count")
  kable(wordsHist, row.names = FALSE, caption = paste("Most frequent words on", themeName))
}

topWordsByTheme("boclips.com")
topWordsByTheme("pearson.boclips.com")
topWordsByTheme("watchboclips.com")

```