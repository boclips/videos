---
title: "Search analysis: past 30 days"
output: pdf_document
---
```{r setup, include=FALSE}
library(knitr)
library(analytics)

knitr::opts_chunk$set(echo = FALSE, comment=NA)

searches = load_search_requests("all-searches.csv", "all-users.csv", after = as.Date("2018-05-01"))
```

# How are search queries counted
In this analysis we count search queries as distinct phrases typed by a user. That means that:

- When a user types some text and hits 'search', this is counted as one search query.
- When a user explores further pages of search results, it is NOT counted as another query.
- When a user uses filters to narrow down results, it is NOT counted as another query.
- When a user goes back to boclips one week after they made a search and types the same phrase they had used before, it is NOT counted as another query.
- When two different users type the same text, it is counted as 2 queries.

The following numbers are based on the above definition.

# Volume of search queries
```{r themes}
searches$theme %>% 
  freqs_table(valuesAsFactors = TRUE) %T>%
  kable(caption = "Queries by theme", col.names = c("Theme", "Count"), row.names = FALSE) %T>%
  plot(., type="s", xlab="value", ylab="count")
```

# Most active users per theme
Here are the users who made the most search queries.
```{r users}
activeUsersByTheme = function(themeName) {
  searches %>% with_theme(themeName) %>% .$email %>% 
    freqs_table(min.count = 5, limit.rows = 50) %>%
    kable(caption = paste("Most active users on", themeName), row.names = FALSE, col.names = c("Email", "# Queries"))
}

activeUsersByTheme("boclips.com")
activeUsersByTheme("pearson.boclips.com")
activeUsersByTheme("watchboclips.com")
```

# Most active email domains
```{r domains}
searches$email %>% email_domain %>% freqs_table(min.count = 5, limit.rows = 20) %T>%
    write.csv(file = "domains.csv", row.names = FALSE) %>%
    kable(caption = "Most active email domains", row.names = FALSE, col.names = c("Domain", "# Queries"))
```

# Search phrases
Here are the most commonly used search phrases.
```{r phraseFreqs}
topPhrasesByTheme = function(themeName) {
  searches %>% with_theme(themeName) %>% .$query %>%
    clean_phrases %>%
    freqs_table %T>%
    write.csv(file = paste("phrases-", themeName, ".csv", sep = ""), row.names = FALSE) %>%
    freqs_table_filter(limit.rows = 100, min.count = 2) %>%
    kable(row.names = FALSE, caption = paste("Most frequent phrases on", themeName))
}

topPhrasesByTheme("boclips.com")
topPhrasesByTheme("pearson.boclips.com")
topPhrasesByTheme("watchboclips.com")
```

## Search words
```{r wordFreqs}
topWordsByTheme = function(themeName) {
  searches %>% with_theme(themeName) %>% .$query %>%
    clean_words %>%
    freqs_table %T>%
    write.csv(file = paste("words-", themeName, ".csv", sep = ""), row.names = FALSE) %>%
    freqs_table_filter(min.count = 2, limit.rows = 100) %>%
    kable(row.names = FALSE, caption = paste("Most frequent words on", themeName))
}

topWordsByTheme("boclips.com")
topWordsByTheme("pearson.boclips.com")
topWordsByTheme("watchboclips.com")
```
