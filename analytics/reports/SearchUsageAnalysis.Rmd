---
title: "Search analysis: past year"
output: pdf_document
---
```{r setup, include=FALSE}
library(knitr)
library(analytics)

knitr::opts_chunk$set(echo = FALSE, comment=NA)

timeRangeStart = seq(Sys.Date(), length = 2, by = "-12 month")[2]
searches = load_search_requests("all-searches.csv", "all-users.csv", after = timeRangeStart)
```

# How are search queries counted
In this analysis we count search queries as distinct phrases typed by a user. That means that:

- When a user types some text and hits 'search', this is counted as one search query.
- When a user explores further pages of search results, it is NOT counted as another query.
- When a user uses filters to narrow down results, it is NOT counted as another query.
- When a user goes back to boclips one week after they made a search and types the same phrase they had used before, it is NOT counted as another query.
- When two different users type the same text, it is counted as 2 queries.

The following numbers are based on the above definition.

# Volume of search queries
```{r themes}
searches$theme %>%
  freqs_table(valuesAsFactors = TRUE) %T>%
  kable(caption = "Queries by theme", col.names = c("Theme", "Count"), row.names = FALSE) # %T>%
  # plot(., type="s", xlab="value", ylab="count")
```

```{r users}
# Most active users per theme
activeUsersByTheme = function(themeName) {
  searches %>% with_theme(themeName) %>% .$email %>%
    freqs_table(min.count = 5, limit.rows = 50) %>%
    kable(caption = paste("Most active users on", themeName), row.names = FALSE, col.names = c("Email", "# Queries"))
}

# activeUsersByTheme("boclips.com")
# activeUsersByTheme("pearson.boclips.com")
# activeUsersByTheme("watchboclips.com")
```

```{r domains}
# Most active email domains
#searches$email %>% email_domain %>% freqs_table(min.count = 5, limit.rows = 20) %T>%
#    write.csv(file = "domains.csv", row.names = FALSE) %>%
#    kable(caption = "Most active email domains", row.names = FALSE, col.names = c("Domain", "# Queries"))
```

# Search phrases
Here are the most commonly used search phrases.
```{r phraseFreqs}
topPhrasesByTheme = function(themeName) {
  searches %>% with_theme(themeName) %>% .$query %>%
    clean_phrases %>%
    freqs_table %T>%
    write.csv(file = paste("phrases-", themeName, ".csv", sep = ""), row.names = FALSE) %>%
    freqs_table_filter(limit.rows = 500, min.count = 4) %>%
    kable(row.names = FALSE, caption = paste("Most frequent phrases on", themeName))
}

topPhrasesByTheme("boclips.com")
topPhrasesByTheme("pearson.boclips.com")
topPhrasesByTheme("watchboclips.com")
```

## Search words
```{r wordFreqs}
topWordsByTheme = function(themeName) {
  searches %>% with_theme(themeName) %>% .$query %>%
    clean_words %>%
    freqs_table %T>%
    write.csv(file = paste("words-", themeName, ".csv", sep = ""), row.names = FALSE) %>%
    freqs_table_filter(min.count = 4, limit.rows = 500) %>%
    kable(row.names = FALSE, caption = paste("Most frequent words on", themeName))
}

topWordsByTheme("boclips.com")
topWordsByTheme("pearson.boclips.com")
topWordsByTheme("watchboclips.com")
```


# Data set
```{r dates}
cat(paste(timeRangeStart, "-", Sys.Date()))
```
